const int IR_LED_PIN = 7;   // IR LED pin
const int IR_RECEIVER_PIN = 4;  // IR receiver pin
const int IR_RECEIVER_PIN2 = 6  ;
const int BUZZER_PIN = 8;  // Buzzer pin
const int DEBOUNCE_DELAY = 50; // Debounce delay in milliseconds
const int led_red = 50;
const int led_green = 51;
const int led_yellow = 52;
int led_delay = 70;
int x = 180;

int check = false;
int check1 = false;
int check2= false;
int check2_F = false;
int check_state_servo = false;
int check3 =false;
int check_fina = false;

int stack_key =0;
  
#include <Servo.h>
Servo myservo; //ประกาศตัวแปรแทน Servo
Servo myservo2;

#include <Keypad.h>
const byte ROWS = 4; //four rows
const byte COLS = 4; //three columns
char keys[ROWS][COLS] = {
  {'1', '2', '3', 'A'},
  {'4', '5', '6', 'B'},
  {'7', '8', '9', 'C'},
  {'*', '0', '#', 'D'}
};
byte rowPins[ROWS] = {22, 24, 26, 28};
byte colPins[COLS] = {30, 32, 34, 36};
Keypad keypad = Keypad( makeKeymap(keys), rowPins, colPins, ROWS, COLS );

const int log_password= 53;
int password = 0;

#include <LCD_I2C.h>
#include "DHT.h"
#define DHTPIN 2     // what digital pin we're connected to

// Uncomment whatever type you're using!
//#define DHTTYPE DHT11   // DHT 11
#define DHTTYPE DHT11   // DHT 22  (AM2302), AM2321
DHT dht(DHTPIN, DHTTYPE);

LCD_I2C lcd(0x27, 16, 2); // Default address of most PCF8574 modules, change according

int debounceAnalogRead(int pin) {
  int val = digitalRead(pin);
  delay(DEBOUNCE_DELAY);
  int newVal = digitalRead(pin);
  if (abs(val - newVal) < 10) {
    return newVal;
  } else {
    return val;
  }
}

int respond_led1(int delays){
  digitalWrite(led_red,1);
  delay(delays);
  digitalWrite(led_green,1);
  delay(delays);
  digitalWrite(led_yellow,1);
  delay(delays);
  digitalWrite(led_red,0);
  delay(delays);
  digitalWrite(led_green,0);
  delay(delays);
  digitalWrite(led_yellow,0);
  
  }

int respond_led2(int delays){
  digitalWrite(led_red,1);
  delay(delays);
  digitalWrite(led_red,0);
  delay(delays);
  digitalWrite(led_green,1);
  delay(delays);
  digitalWrite(led_green,0);
  delay(delays);
  digitalWrite(led_yellow,1);
  delay(delays);
  digitalWrite(led_yellow,0);
  delay(delays);
  }

void setup() {
  pinMode(IR_LED_PIN, OUTPUT);
  pinMode(IR_RECEIVER_PIN, INPUT);
  pinMode(BUZZER_PIN, OUTPUT);

  pinMode(led_red, OUTPUT);
  pinMode(led_green, OUTPUT);
  pinMode(led_yellow, OUTPUT);
  
  Serial.begin(9600);
  lcd.begin(); 
  lcd.backlight();
  myservo.attach(2); // กำหนดขา 9 ควบคุม Servo
  myservo2.attach(3);
}

void loop() {
  
  if(digitalRead(BUZZER_PIN) or check){
    if(check1==false){
    lcd.setCursor(0,0);
    lcd.print("INSERT PASSWORD:))");
    lcd.setCursor(5,1);
    lcd.print("7 Digit");
    }
    check = true;
    check1 = true;
    char key = keypad.getKey();
    
    if (key != NO_KEY and check2==false) {
      stack_key +=1;
      lcd.setCursor(1,0);
      lcd.print("INSERT PASSWORD :");
      lcd.setCursor(1,1);
      lcd.print(">>>>>>>");
      lcd.setCursor(8,1);
      lcd.print(key);
      lcd.setCursor(9,1);
      lcd.print("<<<<<<<");
      delay(1000);
      lcd.clear();
      lcd.setCursor(8,0);
      lcd.print("SET");
      lcd.setCursor(8,1);
      lcd.print(stack_key);
      delay(500);
      lcd.clear();

      
      password += int(key);
      if(stack_key==1){
        if(password == log_password){
          check2=true;
          }
        else{
          check2_F=true;
          check2=true;
          }
      }
      Serial.println(password);
    }

    if(check2_F == true and check2==true){
      digitalWrite(BUZZER_PIN,HIGH);
      delay(1000);
      lcd.setCursor(3,0);
      lcd.print("Fail !!");
      digitalWrite(BUZZER_PIN,LOW);
      delay(1000);
      digitalWrite(BUZZER_PIN,HIGH);
      lcd.clear();
      lcd.setCursor(3,1);
      lcd.print("TOT...");
      delay(1000); 
      lcd.clear();
      check2 =false;
      check2_F = false;
      check = true;
      check1 = false;
      stack_key = 0;
      password =0;
      digitalWrite(BUZZER_PIN,LOW);
      }
        
    

    if(check2 == true and check3==false and check2_F == false){ 
      lcd.setCursor(3,0);
      lcd.print("Success !!");
      delay(1000);
      lcd.clear();
      lcd.setCursor(3,1);
      lcd.print("WELCOME :)");
      delay(1000); 
      lcd.clear();
      check_state_servo = true;
      }

   if(check_state_servo==true){
    for (int i = 180; i > 0; i--) {
    myservo.write(i);
    myservo2.write(i);                         
    delay(10);
    x-=1; 
  }
    
    check_state_servo = false;
    check3 =true;
    if(x==0){
    check_fina = true;
    x=180;
    }
    }
  if(check_fina==true and digitalRead(IR_RECEIVER_PIN2)){
    respond_led2(led_delay);
    }
  
    
  digitalWrite(BUZZER_PIN, LOW);
//    
  }
 
  
  if(check == false){
    lcd.setCursor(2,0); te
    lcd.print("Secure Door :))");
    delay(1000);
    lcd.clear();    
    
    Serial.println(digitalRead(IR_RECEIVER_PIN));
    digitalWrite(IR_LED_PIN, HIGH);
    delayMicroseconds(100);  // Replace with your desired IR signal timing
    digitalWrite(IR_LED_PIN, LOW);
    delay(10);  // Wait for receiver to settle
  
    // Read status of IR receiver with debouncing
    int receiverValue = debounceAnalogRead(IR_RECEIVER_PIN);
  
    // If the receiver value is high, turn on the buzzer
    if (receiverValue == 1) {
      digitalWrite(BUZZER_PIN, HIGH);
      Serial.println("Buzzer ON");
    } else {
      digitalWrite(BUZZER_PIN, LOW);
      Serial.println("Buzzer OFF");
    }
    
    delay(100);  // Replace with your desired loop delay
  }
}
